#!/bin/bash -e

## OLD DEPRECATED STYLE global secrets
{{range secrets (printf "secret/global/%s/env_vars" (env "SERVICE_ENV")) -}}
{{if not (env (. | toUpper)) -}}
export {{ . | toUpper}}{{with secret (printf "secret/global/%s/env_vars/%s" (env "SERVICE_ENV") .) }}="{{.Data.value}}"{{end}}
{{end -}}
{{end -}}

#OLD DEPRECATED STYLE app secrets
{{range secrets (printf "secret/apps/%s/%s/env_vars" (env "SERVICE_NAME") (env "SERVICE_ENV")) -}}
{{if not (env (. | toUpper)) -}}
export {{ . | toUpper}}{{with secret (printf "secret/apps/%s/%s/env_vars/%s" (env "SERVICE_NAME") (env "SERVICE_ENV") .) }}="{{.Data.value}}"{{end}}
{{end -}}
{{end -}}

######################################################
##                                                  ##
## Add Support for New Vault (0.10.0) Versioned K/V ##
##                                                  ##
######################################################

## OLD DEPRECATED STYLE global secrets
{{range secrets (printf "secret/metadata/global/%s/env_vars" (env "SERVICE_ENV")) -}}
{{if not (env (. | toUpper)) -}}
export {{ . | toUpper}}{{with secret (printf "secret/data/global/%s/env_vars/%s" (env "SERVICE_ENV") .) }}="{{.Data.data.value}}"{{end}}
{{end -}}
{{end -}}

#OLD DEPRECATED STYLE app secrets
{{range secrets (printf "secret/metadata/apps/%s/%s/env_vars" (env "SERVICE_NAME") (env "SERVICE_ENV")) -}}
{{if not (env (. | toUpper)) -}}
export {{ . | toUpper}}{{with secret (printf "secret/data/apps/%s/%s/env_vars/%s" (env "SERVICE_NAME") (env "SERVICE_ENV") .) }}="{{.Data.data.value}}"{{end}}
{{end -}}
{{end -}}
